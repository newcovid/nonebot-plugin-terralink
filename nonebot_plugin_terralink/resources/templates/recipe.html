{% extends "base.html" %}
{% import "macros.html" as macros with context %}

{% block content %}

{# --- å®ï¼šé€’å½’æ¸²æŸ“æ ‘èŠ‚ç‚¹ --- #}
{% macro render_tree_node(tree_node) %}
<li>
    <div class="node-wrapper">
        {{ macros.item_slot(tree_node.item, show_name=True) }}

        {# åˆ¶ä½œç«™å›¾æ ‡ #}
        {% if tree_node.recipes %}
            {% set main_recipe = tree_node.recipes[0] %}
            
            {# [Update] stations (å°é©¼å³°) #}
            {% if main_recipe.stations %}
            <div class="station-mini" title="{{ main_recipe.stations[0].name }}">
                {% if main_recipe.stations[0].imagePath %}
                <img src="{{ to_img_url(main_recipe.stations[0].imagePath) }}">
                {% else %}
                <span style="font-size: 10px;">ğŸ› ï¸</span>
                {% endif %}
            </div>
            {% endif %}

            {# æ¡ä»¶æ˜¾ç¤º #}
            {% if main_recipe.conditions %}
            <div class="node-condition">
                {{ main_recipe.conditions[0] }}
            </div>
            {% endif %}
        {% endif %}
    </div>

    <!-- å­èŠ‚ç‚¹å®¹å™¨ -->
    {% if tree_node.recipes and tree_node.recipes[0].ingredients %}
    <ul>
        {% for ing_obj in tree_node.recipes[0].ingredients %}
            {{ render_tree_node(ing_obj.tree) }}
        {% endfor %}
    </ul>
    {% endif %}
</li>
{% endmacro %}


<div class="panel-header">
    <span class="panel-title">ğŸ”¨ åˆæˆæ ‘: {{ data.root.item.name }}</span>
    <span style="font-size: 14px; color: #aaa;">{{ data.root.item.mod }}</span>
</div>

<div class="section-title">åˆæˆè·¯çº¿</div>
<div class="tree-container">
    <div class="tree">
        <ul>
            {{ render_tree_node(data.root) }}
        </ul>
    </div>
</div>

{% if data.root.recipes|length > 1 %}
<div style="margin-top: 5px; text-align: center; color: #888; font-size: 12px;">
    * è¯¥ç‰©å“è¿˜æœ‰å…¶ä»– {{ data.root.recipes|length - 1 }} ç§åˆæˆé…æ–¹ï¼Œå›¾ä¸­ä»…å±•ç¤ºç¬¬ä¸€ç§ã€‚
</div>
{% endif %}

<!-- ç”¨é€”åˆ—è¡¨ (Update: usage_recipes -> usageRecipes) -->
{% if data.usageRecipes %}
<div class="section-title">å¯ä»¥åˆæˆ</div>
<div style="display: flex; flex-direction: column; gap: 8px;">
    {% for r in data.usageRecipes %}
    {# [Update] ResultId -> resultId #}
    {% set result_node = data.nodes[r.resultId|string] %}
    
    <div class="usage-card">
        <div class="usage-result">
            {% if result_node %}
                {# [Update] Name -> name, ImagePath -> imagePath, ResultCount -> resultCount #}
                {{ macros.item_slot({'name': result_node.name, 'stack': r.resultCount, 'imagePath': result_node.imagePath}, show_name=True) }}
            {% else %}
                {{ macros.item_slot({'name': 'ID:' ~ r.resultId, 'stack': r.resultCount}, show_name=True) }}
            {% endif %}
        </div>

        <div class="usage-middle">
            <div class="usage-station-icon">
                {# [Update] Stations -> stations #}
                {% if r.stations %}
                    {% if r.stations[0].imagePath %}
                    <img src="{{ to_img_url(r.stations[0].imagePath) }}" style="width: 24px; height: 24px;">
                    {% else %}
                    <span style="font-size: 16px;">ğŸ› ï¸</span>
                    {% endif %}
                {% else %}
                    <span style="font-size: 12px;">âœ‹</span>
                {% endif %}
            </div>
            <span style="font-size: 20px; font-weight: bold; color: #666;">â”</span>
        </div>

        <div class="usage-ingredients">
            {# [Update] Ingredients -> ingredients #}
            {% for ing in r.ingredients %}
                {# [Update] ItemId -> itemId #}
                {% set ing_node = data.nodes[ing.itemId|string] %}
                {% if ing_node %}
                    {# [Update] targetId -> targetId #}
                    {% if ing.itemId == data.targetId %}
                        <div style="border: 2px solid #ffce45; border-radius: 6px; padding: 2px; background: rgba(255, 206, 69, 0.1);">
                            {# [Update] Count -> count #}
                            {{ macros.item_slot({'name': ing_node.name, 'stack': ing.count, 'imagePath': ing_node.imagePath}, show_name=False) }}
                        </div>
                    {% else %}
                        {{ macros.item_slot({'name': ing_node.name, 'stack': ing.count, 'imagePath': ing_node.imagePath}, show_name=False) }}
                    {% endif %}
                {% endif %}
            {% endfor %}

            {# [Update] Conditions -> conditions #}
            {% if r.conditions %}
            <div style="width: 100%; display: flex; gap: 5px; flex-wrap: wrap;">
                {% for cond in r.conditions %}
                <span class="usage-condition">{{ cond }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- æç¤ºéšè—æ•°é‡ (Update: hidden_usages_count -> hiddenUsagesCount) -->
{% if data.hiddenUsagesCount > 0 %}
<div style="text-align: center; color: #aaa; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 14px;">
    ... è¿˜æœ‰ <b>{{ data.hiddenUsagesCount }}</b> ä¸ªåˆæˆç”¨é€”æœªæ˜¾ç¤º ...
</div>
{% endif %}

{% endif %}

{% endblock %}