{% extends "base.html" %}
{# å…³é”®ä¿®å¤: æ·»åŠ  with context #}
{% import "macros.html" as macros with context %}

{% block content %}
{#
[Ultimate Fix - CSSå˜é‡æ–¹æ¡ˆ]
1. åœ¨è¿™é‡Œå®šä¹‰ä¸€ä¸ªä¸“é—¨çš„ CSS ç±» .detail-large-iconã€‚
2. ä½¿ç”¨ CSS åŸç”Ÿçš„ calc() å’Œ var() æ¥å¤„ç†è£å‰ªé€»è¾‘ã€‚
3. è¿™æ · HTML æ ‡ç­¾é‡Œçš„ style å±æ€§å°±åªå‰©ä¸‹ç®€å•çš„å˜é‡èµ‹å€¼ï¼Œå½»åº•æ¶ˆé™¤ IDE æŠ¥é”™ã€‚
#}
<style>
    .detail-large-icon {
        max-width: 100px;
        max-height: 100px;
        image-rendering: pixelated;
        object-fit: contain;
        /* å®šä¹‰ CSS å˜é‡é»˜è®¤å€¼ä¸º 1 */
        --frame-cnt: 1;
        /* æ ¸å¿ƒè£å‰ªé€»è¾‘: åº•éƒ¨è£å‰ªé‡ = 100% - (100% / å¸§æ•°) */
        /* å¦‚æœå¸§æ•°ä¸º1ï¼Œåˆ™è£å‰ªé‡ä¸º0ï¼Œæ˜¾ç¤ºå…¨å›¾ï¼›å¦‚æœå¸§æ•°ä¸ºNï¼Œåˆ™ä¿ç•™é¡¶éƒ¨ 1/N */
        object-view-box: inset(0 0 calc(100% - 100% / var(--frame-cnt)) 0);
    }
</style>

<div class="panel-header">
    <span class="panel-title">{{ data.name }}</span>
    <div style="text-align: right;">
        <div style="font-size: 12px; color: #aaa;">ID: {{ data.id }}</div>
        <div style="font-size: 12px; color: #aaa;">{{ data.mod }}</div>
    </div>
</div>

<!-- é¡¶éƒ¨ï¼šå¤§å›¾ + æè¿° + å±æ€§ -->
<div class="detail-top">
    <div class="col" style="width: 40%;">
        <!-- å¤§å›¾æ ‡å±•ç¤º -->
        <div
            style="background: #2b3055; border-radius: 8px; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100px;">
            {% if data.imagePath %}
            {% set frames = data.frameCount or 1 %}

            <!-- 
                         IDE å‹å¥½å‹å†™æ³•:
                         style="--frame-cnt: {{ frames }};" 
                         è¿™å®Œå…¨ç¬¦åˆ "å±æ€§: å€¼;" çš„ CSS è¯­æ³•ç»“æ„ï¼ŒIDE ä¸ä¼šå†æŠ¥é”™ã€‚
                    -->
            <img src="{{ to_img_url(data.imagePath) }}" class="detail-large-icon" style="--frame-cnt: {{ frames }};">
            {% else %}
            <span style="font-size: 40px;">?</span>
            {% endif %}
        </div>
        <!-- æè¿° -->
        {% if data.description and data.description != "None" %}
        <div class="detail-desc-box">
            {{ data.description }}
        </div>
        {% endif %}
    </div>

    <div style="flex: 1;">
        {% if data.stats %}
        <table class="stats-table">
            <tr>
                <td class="stat-name">ç±»å‹</td>
                <td class="stat-val">{{ data.type }}</td>
            </tr>
            {% if data.stats.damage > 0 %}
            <tr>
                <td class="stat-name">ä¼¤å®³</td>
                <td class="stat-val">{{ data.stats.damage }}</td>
            </tr>
            {% endif %}
            {% if data.stats.crit > 0 %}
            <tr>
                <td class="stat-name">æš´å‡»ç‡</td>
                <td class="stat-val">{{ data.stats.crit }}%</td>
            </tr>
            {% endif %}
            {% if data.stats.useTime > 0 %}
            <tr>
                <td class="stat-name">ä½¿ç”¨æ—¶é—´</td>
                <td class="stat-val">{{ data.stats.useTime }}</td>
            </tr>
            {% endif %}
            {% if data.stats.knockBack > 0 %}
            <tr>
                <td class="stat-name">å‡»é€€</td>
                <td class="stat-val">{{ "%.1f"|format(data.stats.knockBack) }}</td>
            </tr>
            {% endif %}
            {% if data.stats.defense > 0 %}
            <tr>
                <td class="stat-name">é˜²å¾¡åŠ›</td>
                <td class="stat-val">{{ data.stats.defense }}</td>
            </tr>
            {% endif %}
            <tr>
                <td class="stat-name">æœ€å¤§å †å </td>
                <td class="stat-val">{{ data.stats.maxStack }}</td>
            </tr>
            <tr>
                <td class="stat-name">ä»·å€¼</td>
                <td class="stat-val">{{ data.stats.value }} é“œ</td>
            </tr>
        </table>
        {% endif %}
    </div>
</div>

<!-- è·å–æ–¹å¼ï¼šæ‰è½/å”®å– -->
{% if data.droppedBy or data.soldBy %}
<div class="section-title">è·å–æ¥æº</div>
<div class="grid-container">
    {% for npc in data.droppedBy %}
    <div class="source-chip">
        <span>âš”ï¸ {{ npc.name }}</span>
    </div>
    {% endfor %}

    {% for npc in data.soldBy %}
    <div class="source-chip" style="border-color: #ffce45;">
        <span>ğŸ’° {{ npc.name }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- ç®€æ˜“åˆæˆé¢„è§ˆ (Query æ¥å£è¿”å›çš„ç®€å•é…æ–¹) -->
{% if data.recipes %}
<div class="section-title">åˆæˆæ–¹å¼ (ç®€ç•¥)</div>
<div class="col">
    {% for recipe in data.recipes %}
    <div class="recipe-row">
        <!-- åˆ¶ä½œç«™ -->
        <div class="recipe-station">
            {% if recipe.stations %}
            {{ macros.item_slot(recipe.stations[0], show_name=True) }}
            {% else %}
            <span style="font-size: 12px; color: #aaa;">å¾’æ‰‹</span>
            {% endif %}
        </div>

        <!-- ææ–™ -->
        <div class="recipe-ingredients">
            {% for ing in recipe.ingredients %}
            {{ macros.item_slot(ing, show_name=False) }}
            {% endfor %}
        </div>

        <div class="recipe-arrow">â¨</div>

        <!-- ç»“æœ -->
        <div class="recipe-result">
            {# [Fix] ä¼ é€’ frameCount ä»¥ç¡®ä¿å³ä¸‹è§’ç»“æœç‰©å“ä¹Ÿèƒ½æ­£ç¡®è£å‰ª #}
            {{ macros.item_slot({'name': recipe.resultName, 'stack': recipe.resultCount, 'imagePath': data.imagePath,
            'frameCount': data.frameCount}, show_name=False) }}
        </div>
    </div>
    {% endfor %}

    <div style="text-align: center; font-size: 12px; color: #aaa; margin-top: 5px;">
        ä½¿ç”¨ /recipe {{ data.id }} æŸ¥çœ‹å®Œæ•´åˆæˆæ ‘
    </div>
</div>
{% endif %}

{% endblock %}